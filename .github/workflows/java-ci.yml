name: Java CI

on:
  push:
    branches:
      - master
    paths:
      - "application/**"
      - ".github/workflows/java-ci.yml"
  pull_request:

jobs:
  init-build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java

      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/parent-pom/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-parent-pom
      - name: Maven Deploy POM to Github Package Registry
        working-directory: ./application/parent-pom/
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify deploy --settings ../.m2/settings.xml
      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/webapp-service/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-webapp-service
      - name: Maven Deploy to Github Package Registry
        working-directory: ./application/webapp-service
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify deploy --settings ../.m2/settings.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Upload coverage to coday
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/webapp-service
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_webapp-service
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  jaxrs-activemq-quarkus:
    needs: init-build
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS
      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/jaxrs-activemq-quarkus/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-jaxrs-activemq-quarkus

      - name: Maven Build
        working-directory: ./application/jaxrs-activemq-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify deploy --settings ../.m2/settings.xml
      - name: Build Image
        working-directory: ./application/jaxrs-activemq-quarkus
        run: docker build -t yurak/jaxrs-activemq-quarkus:latest -f src/main/docker/Dockerfile.jvm .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/jaxrs-activemq-quarkus:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/jaxrs-activemq-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_jaxrs-activemq-quarkus
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  consumer-activemq-quarkus:
    needs: [init-build, jaxrs-activemq-quarkus]
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS

      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/consumer-activemq-quarkus/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-consumer-activemq-quarkus
      - name: Maven Build
        working-directory: ./application/consumer-activemq-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify package --settings ../.m2/settings.xml
      - name: Build Image
        working-directory: ./application/consumer-activemq-quarkus
        run: docker build -t yurak/consumer-activemq-quarkus:latest -f src/main/docker/Dockerfile.jvm .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/consumer-activemq-quarkus:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/consumer-activemq-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_consumer-activemq-quarkus
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  jaxrs-cassandra-quarkus:
    needs: init-build
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS
      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/jaxrs-cassandra-quarkus/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-jaxrs-cassandra-quarkus

      - name: Maven Build
        working-directory: ./application/jaxrs-cassandra-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify package --settings ../.m2/settings.xml
      - name: Build Image
        working-directory: ./application/jaxrs-cassandra-quarkus
        run: docker build -t yurak/jaxrs-cassandra-quarkus:latest -f src/main/docker/Dockerfile.jvm .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/jaxrs-cassandra-quarkus:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/jaxrs-cassandra-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_jaxrs-cassandra-quarkus
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  consumer-hazelcast-quarkus:
    needs: [init-build, jaxrs-hazelcast-quarkus]
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS

      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/consumer-hazelcast-quarkus/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-consumer-hazelcast-quarkus
      - name: Maven Build
        working-directory: ./application/consumer-hazelcast-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify package --settings ../.m2/settings.xml
      - name: Build Image
        working-directory: ./application/consumer-hazelcast-quarkus
        run: docker build -t yurak/consumer-hazelcast-quarkus:latest -f src/main/docker/Dockerfile.jvm .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/consumer-hazelcast-quarkus:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/consumer-hazelcast-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_consumer-hazelcast-quarkus
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  consumer-kafka-quarkus:
    needs: [init-build, jaxrs-kafka-quarkus]
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS

      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/consumer-kafka-quarkus/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-consumer-kafka-quarkus
      - name: Maven Build
        working-directory: ./application/consumer-kafka-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify package --settings ../.m2/settings.xml -Pnative
      - name: Build Image
        working-directory: ./application/consumer-kafka-quarkus
        run: docker build -t yurak/consumer-kafka-quarkus:latest -f src/main/docker/Dockerfile.native .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/consumer-kafka-quarkus:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/consumer-kafka-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_consumer-kafka-quarkus
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  scheduled-quarkus:
    needs: init-build
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS

      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/scheduled-quarkus/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-scheduled-quarkus
      - name: Maven Build
        working-directory: ./application/scheduled-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify package --settings ../.m2/settings.xml -Pnative
      - name: Build Image
        working-directory: ./application/scheduled-quarkus
        run: docker build -t yurak/scheduled-quarkus:latest -f src/main/docker/Dockerfile.native .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/scheduled-quarkus:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/scheduled-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_scheduled-quarkus
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  jaxrs-hazelcast-quarkus:
    needs: init-build
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS

      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/jaxrs-hazelcast-quarkus/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-jaxrs-hazelcast-quarkus
      - name: Maven Build
        working-directory: ./application/jaxrs-hazelcast-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify package --settings ../.m2/settings.xml
      - name: Build Image
        working-directory: ./application/jaxrs-hazelcast-quarkus
        run: docker build -t yurak/jaxrs-hazelcast-quarkus:latest -f src/main/docker/Dockerfile.jvm .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/jaxrs-hazelcast-quarkus:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/jaxrs-hazelcast-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_jaxrs-hazelcast-quarkus
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  jaxrs-kafka-quarkus:
    needs: init-build
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS

      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/jaxrs-kafka-quarkus/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-jaxrs-kafka-quarkus
      - name: Maven Build
        working-directory: ./application/jaxrs-kafka-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify package --settings ../.m2/settings.xml -Pnative
      - name: Build Image
        working-directory: ./application/jaxrs-kafka-quarkus
        run: docker build -t yurak/jaxrs-kafka-quarkus:latest -f src/main/docker/Dockerfile.native .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/jaxrs-kafka-quarkus:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/jaxrs-kafka-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_jaxrs-kafka-quarkus
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  jaxrs-memcached-quarkus:
    needs: init-build
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS

      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/jaxrs-memcached-quarkus/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-jaxrs-memcached-quarkus
      - name: Maven Build
        working-directory: ./application/jaxrs-memcached-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify package --settings ../.m2/settings.xml
      - name: Build Image
        working-directory: ./application/jaxrs-memcached-quarkus
        run: docker build -t yurak/jaxrs-memcached-quarkus:latest -f src/main/docker/Dockerfile.jvm .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/jaxrs-memcached-quarkus:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/jaxrs-memcached-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_jaxrs-memcached-quarkus
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  jaxrs-mongodb-quarkus:
    needs: init-build
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS

      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/jaxrs-mongodb-quarkus/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-jaxrs-mongodb-quarkus
      - name: Maven Build
        working-directory: ./application/jaxrs-mongodb-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify package --settings ../.m2/settings.xml
      - name: Build Image
        working-directory: ./application/jaxrs-mongodb-quarkus
        run: docker build -t yurak/jaxrs-mongodb-quarkus:latest -f src/main/docker/Dockerfile.jvm .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/jaxrs-mongodb-quarkus:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/jaxrs-mongodb-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_jaxrs-mongodb-quarkus
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  jaxrs-mysql-quarkus:
    needs: init-build
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS

      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/jaxrs-mysql-quarkus/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-jaxrs-mysql-quarkus
      - name: Maven Build
        working-directory: ./application/jaxrs-mysql-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify package --settings ../.m2/settings.xml
      - name: Build Image
        working-directory: ./application/jaxrs-mysql-quarkus
        run: docker build -t yurak/jaxrs-mysql-quarkus:latest -f src/main/docker/Dockerfile.jvm .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/jaxrs-mysql-quarkus:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/jaxrs-mysql-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_jaxrs-mysql-quarkus
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  jaxrs-postgres-quarkus:
    needs: init-build
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS

      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/jaxrs-postgres-quarkus/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-jaxrs-postgres-quarkus
      - name: Maven Build
        working-directory: ./application/jaxrs-postgres-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify package --settings ../.m2/settings.xml
      - name: Build Image
        working-directory: ./application/jaxrs-postgres-quarkus
        run: docker build -t yurak/jaxrs-postgres-quarkus:latest -f src/main/docker/Dockerfile.jvm .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/jaxrs-postgres-quarkus:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/jaxrs-postgres-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_jaxrs-postgres-quarkus
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  jaxrs-rabbitmq-quarkus:
    needs: init-build
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS

      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/jaxrs-rabbitmq-quarkus/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-jaxrs-rabbitmq-quarkus
      - name: Maven Build
        working-directory: ./application/jaxrs-rabbitmq-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify deploy --settings ../.m2/settings.xml
      - name: Build Image
        working-directory: ./application/jaxrs-rabbitmq-quarkus
        run: docker build -t yurak/jaxrs-rabbitmq-quarkus:latest -f src/main/docker/Dockerfile.jvm .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/jaxrs-rabbitmq-quarkus:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/jaxrs-rabbitmq-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_jaxrs-rabbitmq-quarkus
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  jaxrs-redis-quarkus:
    needs: init-build
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS

      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/jaxrs-redis-quarkus/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-jaxrs-redis-quarkus
      - name: Maven Build
        working-directory: ./application/jaxrs-redis-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify deploy --settings ../.m2/settings.xml
      - name: Build Image
        working-directory: ./application/jaxrs-redis-quarkus
        run: docker build -t yurak/jaxrs-redis-quarkus:latest -f src/main/docker/Dockerfile.jvm .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/jaxrs-redis-quarkus:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/jaxrs-redis-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_jaxrs-redis-quarkus
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  consumer-rabbitmq-quarkus:
    needs: [init-build, jaxrs-rabbitmq-quarkus]
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS

      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/consumer-rabbitmq-quarkus/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-consumer-rabbitmq-quarkus
      - name: Maven Build
        working-directory: ./application/consumer-rabbitmq-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify package --settings ../.m2/settings.xml
      - name: Build Image
        working-directory: ./application/consumer-rabbitmq-quarkus
        run: docker build -t yurak/consumer-rabbitmq-quarkus:latest -f src/main/docker/Dockerfile.jvm .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/consumer-rabbitmq-quarkus:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/consumer-rabbitmq-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_consumer-rabbitmq-quarkus
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  producer-kafka-quarkus:
    needs: [init-build, jaxrs-kafka-quarkus]
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS

      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/producer-kafka-quarkus/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-producer-kafka-quarkus
      - name: Maven Build
        working-directory: ./application/producer-kafka-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify package --settings ../.m2/settings.xml -Pnative
      - name: Build Image
        working-directory: ./application/producer-kafka-quarkus
        run: docker build -t yurak/producer-kafka-quarkus:latest -f src/main/docker/Dockerfile.native .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/producer-kafka-quarkus:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/producer-kafka-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_producer-kafka-quarkus
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  randompublish-quarkus:
    needs: init-build
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS

      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/randompublish-quarkus/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-randompublish-quarkus
      - name: Maven Build
        working-directory: ./application/randompublish-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify package --settings ../.m2/settings.xml -Pnative
      - name: Build Image
        working-directory: ./application/randompublish-quarkus
        run: docker build -t yurak/randompublish-quarkus:latest -f src/main/docker/Dockerfile.native .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/randompublish-quarkus:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/randompublish-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_randompublish-quarkus
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  redis-mysql-helidon:
    needs: init-build
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/redis-mysql-helidon/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-redis-mysql-helidon

      - name: Maven Build - redis-mysql-helidon
        working-directory: ./application/redis-mysql-helidon
        run: mvn -B verify package

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/redis-mysql-helidon
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: mvn sonar:sonar
          -Dsonar.projectKey=yurake_redis-mysql-helidon
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  consumer-redis-quarkus:
    needs: [init-build, jaxrs-redis-quarkus]
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS

      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/consumer-redis-quarkus/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-consumer-redis-quarkus
      - name: Maven Build
        working-directory: ./application/consumer-redis-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw -B verify package --settings ../.m2/settings.xml
      - name: Build Image
        working-directory: ./application/consumer-redis-quarkus
        run: docker build -t yurak/consumer-redis-quarkus:latest -f src/main/docker/Dockerfile.jvm .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/consumer-redis-quarkus:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/consumer-redis-quarkus
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./mvnw sonar:sonar
          -Dsonar.projectKey=yurake_consumer-redis-quarkus
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  wlp-web-java-spring:
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
      - name: Setup GraalVM
        uses: DeLaGuardo/setup-graalvm@8bbfe44ef9c6f5c07e5af036a1bffd561c037d18
        with:
          graalvm-version: 20.2.0.java11
      - run: java -version
      - name: setup-native-image
        run: |
          gu install native-image
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: java
      - name: docker login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
        run: docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS

      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/wlp-web-java-spring/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-wlp-web-java-spring
      - name: Maven Build
        working-directory: ./application/wlp-web-java-spring
        run: mvn -B verify package --settings ../.m2/settings.xml
      - name: Copy war file
        uses: canastro/copy-file-action@master
        with:
          source: "application/wlp-web-java-spring/target/spring.war"
          target: "kubernetes/wlp/spring.war"
      - name: Build image
        working-directory: ./kubernetes/wlp
        run: docker build -t yurak/wlp:latest .
      - name: Push Image
        if: github.event_name == 'push'
        run: docker push yurak/wlp:latest

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      - name: Upload coverage to SonarCloud
        working-directory: ./application/wlp-web-java-spring
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: mvn sonar:sonar
          -Dsonar.projectKey=yurake_wlp-web-java-spring
          -Dsonar.organization=yurak
          -Dsonar.host.url=https://sonarcloud.io/
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1
