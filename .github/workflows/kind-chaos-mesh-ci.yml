name: kind Chaos Mesh CI

on:
  push:
    branches:
      - master
    paths:
      - "**.yaml"
      - ".github/workflows/kind-chaos-mesh-ci.yml"
  pull_request:
    paths:
      - "**.yaml"
      - ".github/workflows/kind-chaos-mesh-ci.yml"

jobs:
  chaos-mesh-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Kind Cluster
        uses: helm/kind-action@v1.4.0

      - name: Print cluster information
        run: |
          kubectl config view
          kubectl cluster-info
          kubectl get nodes
          kubectl get pods -n kube-system
          helm version
          kubectl version
      - uses: actions/checkout@v3
      - name: Deploy an application
        run: |
          kubectl apply -f kubernetes/mysql/mysql-pv.yaml
          kubectl apply -f kubernetes/mysql/mysql-pvc.yaml
          kubectl apply -f kubernetes/mysql/mysql-configmap.yaml
          kubectl apply -f kubernetes/mysql/mysql-secret.yaml
          kubectl apply -f kubernetes/mysql/mysql-deployment.yaml
          kubectl apply -f kubernetes/mysql/mysql-service.yaml
          kubectl apply -f kubernetes/jaxrs-mysql-quarkus/jaxrs-mysql-quarkus-service.yaml
          kubectl apply -f kubernetes/jaxrs-mysql-quarkus/jaxrs-mysql-quarkus-deployment.yaml

      - name: Wait pod status to running
        run: |
          kubectl wait --all-namespaces=true --for=condition=ready pod -l component=quarkus --timeout=15m
          kubectl wait --all-namespaces=true --for=condition=ready pod -l app=mysql --timeout=5m

      - name: Check pods
        run: |
          kubectl get pods -n chaos-testing
          kubectl get pods

      - name: base64 encode manifests
        working-directory: ./kubernetes/test/chaos-mesh/experiments
        run: |
          echo "CFG_BASE64_BURN_CPU=$(base64 burn-cpu.yaml)" >> $GITHUB_ENV
          echo "CFG_BASE64_CONTAINER_KILL=$(base64 container-kill.yaml)" >> $GITHUB_ENV
          echo "CFG_BASE64_IO_DEPLOY=$(base64 io-delay.yaml)" >> $GITHUB_ENV
          echo "CFG_BASE64_NETWORK_DELAY=$(base64 network-delay.yaml)" >> $GITHUB_ENV
          echo "CFG_BASE64_NETWORK_LOSS=$(base64 network-loss.yaml)" >> $GITHUB_ENV
          echo "CFG_BASE64_NETWORK_FAILURE=$(base64 pod-failure.yaml)" >> $GITHUB_ENV
          echo "CFG_BASE64_POD_KILL=$(base64 pod-kill.yaml)" >> $GITHUB_ENV
          echo "CFG_BASE64_TIME_SHIFT=$(base64 time-shift.yaml)" >> $GITHUB_ENV

      - name: Chaos Mesh burn-cpu
        uses: chaos-mesh/chaos-mesh-action@v0.5
        env:
          CFG_BASE64: ${CFG_BASE64_BURN_CPU}
          CHAOS_MESH_VERSION: v1.0.0

      - name: Check status burn-cpu
        run: |
          for i in `seq 15`
          do
          kubectl get pods -n chaos-testing
          kubectl get pods
          sleep 1
          done

      - name: Chaos Mesh container-kill
        uses: chaos-mesh/chaos-mesh-action@v0.5
        env:
          CFG_BASE64: ${CFG_BASE64_CONTAINER_KILL}
          CHAOS_MESH_VERSION: v1.0.0

      - name: Check status container-kill
        run: |
          for i in `seq 15`
          do
          kubectl get pods -n chaos-testing
          kubectl get pods
          sleep 1
          done

      - name: Chaos Mesh io-delay
        uses: chaos-mesh/chaos-mesh-action@v0.5
        env:
          CFG_BASE64: ${CFG_BASE64_IO_DEPLOY}
          CHAOS_MESH_VERSION: v1.0.0

      - name: Check status io-delay
        run: |
          for i in `seq 15`
          do
          kubectl get pods -n chaos-testing
          kubectl get pods
          sleep 1
          done

      - name: Chaos Mesh network-delay
        uses: chaos-mesh/chaos-mesh-action@v0.5
        env:
          CFG_BASE64: ${CFG_BASE64_NETWORK_DELAY}
          CHAOS_MESH_VERSION: v1.0.0

      - name: Check status network-delay
        run: |
          for i in `seq 15`
          do
          kubectl get pods -n chaos-testing
          kubectl get pods
          sleep 1
          done

      - name: Chaos Mesh network-loss
        uses: chaos-mesh/chaos-mesh-action@v0.5
        env:
          CFG_BASE64: ${CFG_BASE64_NETWORK_LOSS}
          CHAOS_MESH_VERSION: v1.0.0

      - name: Check status network-loss
        run: |
          for i in `seq 15`
          do
          kubectl get pods -n chaos-testing
          kubectl get pods
          sleep 1
          done

      - name: Chaos Mesh pod-failure
        uses: chaos-mesh/chaos-mesh-action@v0.5
        env:
          CFG_BASE64: ${CFG_BASE64_NETWORK_FAILURE}
          CHAOS_MESH_VERSION: v1.0.0

      - name: Check status pod-failure
        run: |
          for i in `seq 15`
          do
          kubectl get pods -n chaos-testing
          kubectl get pods
          sleep 1
          done

      - name: Chaos Mesh pod-kill.yaml
        uses: chaos-mesh/chaos-mesh-action@v0.5
        env:
          CFG_BASE64: ${CFG_BASE64_POD_KILL}
          CHAOS_MESH_VERSION: v1.0.0

      - name: Check status pod-kill.yaml
        run: |
          for i in `seq 15`
          do
          kubectl get pods -n chaos-testing
          kubectl get pods
          sleep 1
          done

      - name: Chaos Mesh time-shift.yaml
        uses: chaos-mesh/chaos-mesh-action@v0.5
        env:
          CFG_BASE64: ${CFG_BASE64_TIME_SHIFT}
          CHAOS_MESH_VERSION: v1.0.0

      - name: Check status time-shift.yaml
        run: |
          for i in `seq 15`
          do
          kubectl get pods -n chaos-testing
          kubectl get pods
          sleep 1
          done

      - name: check log jaxrs-mysql
        if: always()
        run: |
          kubectl describe po $(kubectl get pods | awk '{print $1}' | grep jaxrs-mysql)
          kubectl logs $(kubectl get pods | awk '{print $1}' | grep jaxrs-mysql)

      - name: check log mysql
        if: always()
        run: |
          kubectl describe po $(kubectl get pods | awk '{print $1}' | grep -E ^mysql)
          kubectl logs $(kubectl get pods | awk '{print $1}' | grep -E ^mysql) -c mysql
